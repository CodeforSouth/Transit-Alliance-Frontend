
function checkFlexMenu(){
  if ($('.flexMenu-viewMore').length){
    $('.flexMenu-viewMore> ul > li').unwrap().prev().unwrap().first().remove();
  }
}


// check for resize events + setTimeout to economize use ------------
function resizeId(){

  $(window).on('resize', function(e) {
    clearTimeout(resizeId);
    resizeId = setTimeout(doneResizing, 350);
  });

}

// check screen width
function doneResizing(){

  if (window.innerWidth < '992'){

    // if Flex function ran remove structure
    checkFlexMenu();

    $('.global-header-container').removeClass('navbar-fixed');

  } else {

    //Adds "MORE" when top nav is too long
    $('ul.page-navigation__list').flexMenu({
      cutoff: 1
    });

    //Deleting the display:block that shows up inline


    setTimeout(function(){ $('.flexMenu-popup').css('display',''); }, 500);


    if (!$('.global-header-container').hasClass("navbar-fixed")) {

      $(window).on('scroll' , function(e){
        var globalNavigation = $('.global-header-container');
        var windowTop = $(window).scrollTop() > 5;

        if (windowTop) {
            globalNavigation.addClass('navbar-fixed');
        } else {
            globalNavigation.removeClass('navbar-fixed');
        };

      });



    }

    //checkDropdown();


  };

  fixedPageNavigation();

}

function checkDropdown(){

  if ($(window).innerWidth() < $('ul.site-nav-content > li.dropdown:last > ul').offset().left + 495){

    var windowWidth = $(window).innerWidth();

    $('ul.site-nav-content > li.dropdown > ul').each(function(){

      $(this).removeAttr('style');//Remove inline style if the script ran. Start fresh each time.

      var navDropdown = $(this).offset().left + 495;
      var sum = windowWidth - navDropdown; //Gets how much of the dropdown is off the screen.

      if (navDropdown > windowWidth){
        $(this).css('left', sum);
      }

      if (sum < -184){
        $(this).removeAttr('style'); //Remove inline-style to readjust to opening to the left instead of the right.
        $(this).parent('.dropdown').addClass('noflex-dropdown');
      }

    });
  }

}

// adds back to top button
function backToTop(){

  var lastScrollTop = 0;

  $(window).on('scroll' , function(e){

    var st = $(this).scrollTop();

       if (st > lastScrollTop){
           // downscroll code
           $('.back-to-top').removeClass('top-active');

       } else {
          // upscroll code
          if(st < 350) {

            $('.back-to-top').removeClass('top-active');
           } else {

              $('.back-to-top').addClass('top-active');
           };
       };

       lastScrollTop = st;
    });

}


function sticky_relocate() {

  /*

    if($('.sticky-anchor').length) {

      var window_top = $(window).scrollTop();
      var div_top = $('.sticky-anchor').offset().top;

      if (window_top > div_top){
          $('.search-filters').addClass('sticky');
      } else {
          $('.search-filters').removeClass('sticky');
      };
  }
  */

}

// animation for the page navigation
function pageNavAnimate(e){

  e.preventDefault();
  var section = $(this).data("page-navigation-items");

  $("html, body").animate({
    scrollTop: $(section).offset().top - 120
  });

}

function fixedPageNavigation() {

  if (window.innerWidth > '600') {

    $(window).on('scroll' , function(e){

      var pageNavigation = $('.pageNavigationContainer-hidden, .banner-initiatives-navigation-hidden');
      var windowTop = $(window).scrollTop();

        if($('.pageNavigationContainer, .banner-initiatives-navigation').length){
          if (windowTop > $('.pageNavigationContainer, .banner-initiatives-navigation').offset().top) {
              pageNavigation.addClass('fixed');
          } else {
              pageNavigation.removeClass('fixed');
          };
        };
    });

  };

}






// .COM / .NET WARNING DISCLAIMER --------------------------------
//0 means disabled; 1 means enabled;
var popupStatus = 0;

function loadPopup(){
  //loads popup only if it is disabled
  if(popupStatus==0){
    $("#pwBackgroundPopup").css({
      "opacity": "0.7"
    });
    $("#pwBackgroundPopup").fadeIn("slow");
    $("#popupWarning").fadeIn("slow");
    popupStatus = 1;
  }
}

function disablePwPopup(){
  //disables popup only if it is enabled
  if(popupStatus==1){
    $("#pwBackgroundPopup").fadeOut("slow");
    $("#popupWarning").fadeOut("slow");
    popupStatus = 0;
  }
}

$.fn.centerInClient = function(options) {
    var opt = { forceAbsolute: false,
                container: window,    // selector of element to center in
                completeHandler: null
              };
    $.extend(opt, options);

    return this.each(function(i) {
        var el = $(this);
        var jWin = $(opt.container);
        var isWin = opt.container == window;

        // force to the top of document to ENSURE that
        // document absolute positioning is available
        if (opt.forceAbsolute) {
            if (isWin)
                el.remove().appendTo("body");
            else
                el.remove().appendTo(jWin.get(0));
        }

        // have to make absolute
        el.css("position", "absolute");

        // height is off a bit so fudge it
        var heightFudge = isWin ? 2.0 : 1.8;

        var x = (isWin ? jWin.width() : jWin.outerWidth()) / 2 - el.outerWidth() / 2;
        var y = (isWin ? jWin.height() : jWin.outerHeight()) / heightFudge - el.outerHeight() / 2;

        el.css("left", x + jWin.scrollLeft());
        el.css("top", y + jWin.scrollTop());

        // if specified make callback and pass element
        if (opt.completeHandler)
            opt.completeHandler(this);
    });
}



/******************* DOCUMENT READY *******************/


$(document).ready(function() {

  // Initiate Leaving Website Popup  --------------------------------

  $(".popup").on("click", "a", function(){

    ajmNewSiteURL = $(this).attr("href");



    // if($(this).hasClass('exception')) {
    //   return true;
    // } else {
    //   $("#popupWarning").centerInClient();
    //   loadPopup();
    //   return false;
    // }

  });

    // Initiate Leaving Website Popup 2  --------------------------------

  $("body").on("click", "a", function(){

        ajmNewSiteURL = $(this).attr("href");

          var urlWhitelist = [
            'miamidade.gov',
            'miami-airport.com',
            'miami-dadeclerk.com',
            'vizcaya.org',
            'miamidadeig.org',
            'miamidadearts.org',
            'arshtcenter.org',
            'smdcac.org',
            'homelesstrust.org',
            'www.mdpls.org',
            'miamidadetpo.org',
            'zoomiami.org',
            'deeringestate.org',
            'historymiami.org',
            'miamidade.granicus.com',
			      'portal.unitedwaymiami.org',
            'translate.google.com',
            'google.com',
			      'unitedwaymiami.org',
            'miamidadecounty.co1.qualtrics.com',
            'parks305.org',
            'unitedwaymiami.org',
            'govtech.com',
            '#cd-search',
            '#main-content'
          ];


          if(ajmNewSiteURL === '#' || ajmNewSiteURL == 'null' || ajmNewSiteURL.indexOf('/') == 0) {
            return true;
          }


          if($(this).hasClass('activatePopup')) {
            $("#popupWarning").centerInClient();
            loadPopup();
            return false;
          }

          if($(this).hasClass('exception')) {
            return true;
          }


        // Check if the link the user clicked on has an href value that matches any of the values in the whitelist.
        var matchingList = [];

        // If one of the values matches then we push the match into an array.
        urlWhitelist.map( function(url) {
          if(ajmNewSiteURL.indexOf(url) > -1) {
            matchingList.push(url);
          }
        });


        // If the matchingList array contains a value then the link is whitelisted.
        if(matchingList.length > 0) {
          return true;
        } else {

          // Otherwise, the popup displays.
          $("#popupWarning").centerInClient();
          loadPopup();
          return false;
        }

  });

  //closing popup
  //Click the x event!
  $("#popupWarningClose").click(function(){
    disablePwPopup();
  });

  $("#pwAlertButton").click(function(){
    disablePwPopup();
    window.open(ajmNewSiteURL);
  });

  $("#cancelButton").click(function(){
    disablePwPopup();
  });

  //Click out event!
  $("#pwBackgroundPopup").click(function(){
    disablePwPopup();
  });
  //Press Escape event!
  $(document).keypress(function(e){
    if(e.keyCode==27 && pwPopupStatus==1){
      disablePwPopup();
    }
  });





    //mobile tabs ------------
    $('ul.mobile-top-menu__tabs li').on('click', function(e){
      e.preventDefault;

        var tab_id = $(this).attr('data-tab');

        $('ul.mobile-top-menu__tabs li').removeClass('mobile-top-menu__tab--active');
        $('.mobile-content-tab').removeClass('mobile-content-tab--active');

        $(this).addClass('mobile-top-menu__tab--active');
        $("#"+tab_id).addClass('mobile-content-tab--active');
    });


    //mobile jquery ------------

    var mobileMenu = $('#mobile-menu').unbind();

    mobileMenu.on('click', function(e) {
      e.preventDefault();

      $('.mobile-global-nav').addClass('active');

    });

    $('#mobile-global-close').on ('click', function(e){
      e.preventDefault();
      $('.mobile-global-nav').removeClass('active');
    });


  // mobile search
  $('input#search-query-mobile').focus(function() { $(this).parent().addClass('focused'); });
  $('input#search-query-mobile').blur(function() {
    if (!$(this).val()) {
      $(this).parent().removeClass('focused');
    }
  });


  if($('#cd-search').length) {
    $('.cd-search-trigger-desktop').show();
  }
  //open search form
  $('#searchDesktop').unbind('click').click(function(e){
    e.preventDefault();
    toggleSearch('open');
  });

  $('#searchMobile').unbind('click').click(function(e){
    e.preventDefault();
    toggleSearch('mobile');
  });

  $('.cd-overlay').unbind('click').click(function(e){
    toggleSearch('close');
    $('.cd-overlay').removeClass('is-visible-mobile');
    $('.cd-search-trigger-mobile').removeClass('search-is-visible');
  });

  function toggleSearch(type) {

    switch (type) {
      case 'close':
        $('.cd-search').removeClass('is-visible');
        $('.cd-search-mobile').removeClass('is-visible-mobile');
        $('#searchDesktop, #searchDesktop').removeClass('search-is-visible');
        $('.cd-overlay').removeClass('search-is-visible');
      break;

      case 'mobile':
        $('.cd-search-mobile').toggleClass('is-visible-mobile');
        $('.cd-search-trigger-mobile').toggleClass('search-is-visible');

        $('.cd-search').toggleClass('is-visible');
        $('.cd-search-trigger').toggleClass('search-is-visible');

        $('.cd-overlay').toggleClass('search-is-visible');
        ($('.cd-search-mobile').hasClass('is-visible-mobile')) ? $('.cd-overlay').addClass('is-visible-mobile'): $('.cd-overlay').removeClass('is-visible-mobile');
        setTimeout(function(){$('.mobile-main-search__search').focus();},200); // Need to give time for the element to be visible
      break;

      default:
        $('.cd-search').toggleClass('is-visible');
        $('.cd-search-trigger').toggleClass('search-is-visible');

        $('.cd-search-mobile').toggleClass('is-visible-mobile');
        $('.cd-search-trigger-mobile').toggleClass('search-is-visible');
        
        setTimeout(function(){$('.desktop-main-search__search').focus();},200); // Need to give time for the element to be visible
        // $('.cd-overlay').toggleClass('search-is-visible');
      break;

    }

  }


 // $('body').addClass("loaded");


 if($('#mobile-menu-container').length) {
    $('#mobile-menu-tabs').show();
    $('#mobile-menu-name').prependTo('#tab-mobile-global-menu');
    //$('#mobile-menu-home').prependTo('#mobile-page-menu');
    $('#mobile-menu-item-container').prependTo('#mobile-page-menu');
 } else {
    $('#mobile-menu-tabs ul li:nth-child(2) a').removeClass('active');
    $('#mobile-menu-tabs ul li:first-child a').addClass('active');
  };



 var $sections = $('.spacing');

  $(window).scroll(function() {
    sticky_relocate();





    if($('.pageNavigation, .navigation-highlight').length){

      //page navigation...highlight current section
      var currentScroll = $(this).scrollTop();
      var scrollPosition = $(window).scrollTop();
      var $currentSection

      $sections.each(function(){

        var sectionTop = $(this).offset().top -200;

        // if the user has scrolled over the top of the section
        if (scrollPosition >= sectionTop) {

          var divPosition = $(this).offset().top -180;

          if( divPosition - 1 < currentScroll ){
            $currentSection = $(this);

            var id = $currentSection.attr('id');

            $('li').removeClass('page-highlight-section');
            $('.pageNavigation a').removeClass('active');
            $('.pageNavigation').removeClass('indicator');

            $(".pageNavigation [data-section=#"+id+"]").addClass('page-highlight-section');



          }



        }

      });

    };


});

  //weather widget for dashboard
if($('.dashboard').length) {

  $.simpleWeather({
    woeid: '',
    location: 'Miami, FL',
    unit: 'f',
    success: function(weather) {
      html = '<h1 class="icon-'+weather.code+'"></h1>';
      html += '<h2>'+weather.temp+'°</h2>';
      html += '<li class="currently">'+weather.currently+'</li></ul>';
      $("#weather").html(html);
    },
    error: function(error) {
      $("#weather").html('<p>'+error+'</p>');
    }
  });

}


// page navigation slide to section
   $('.pageNavigationContainer .page-navigation-items, .pageNavigationContainer-hidden .page-navigation__item, .pageNavigation-mobile li, .service-list-tab-container-mobile li, .banner-initiatives-navigation li, .banner-initiatives-navigation-hidden li, .page-navigation-slide li').on('click', function (e) {


    e.preventDefault();

    $('li').removeClass('page-highlight-section');

   // $(this).addClass('page-highlight-click');

        var toGo = $(this).data('section');



        if(window.innerWidth < '601') {

          if($('.service-list-tab-container-mobile li').length){
            $('html,body').animate({
                scrollTop: $('#' + toGo).offset().top -60
            }, 'slow');
          } else {
            $('html,body').animate({
                scrollTop: $('#' + toGo).offset().top
            }, 'slow');
          }

        } else {

          if ($('.banner-initiatives-navigation li, .banner-initiatives-navigation-hidden li').length) {
            $('html,body').animate({
              scrollTop: $('#' + toGo).offset().top -180
            }, 'slow');
          } else {
            $('html,body').animate({
              scrollTop: $('#' + toGo).offset().top -140
            }, 'slow');

          }

        };

    });

// page navigation to match
  $('.pageNavigationContainer .page-navigation__item').on('click', function (e) {

    var capture = $(this).attr('data-section');

    $('.pageNavigationContainer-hidden ul > li[data-section = '+capture+'] a').trigger('click');

    e.preventDefault();

   });

  // capture click on search icon - check width again in case of screen size change
  $('#global-icon-search a').on('click',function(e){

    $('#main-container').removeClass('profile-sub-active');

    $('#global-icon-search').toggleClass('search-sub-active');

    // handle focus of search input
    if ($('#global-icon-search').hasClass('search-sub-active')) {
      // set timeout doesn't seem to be working on mobile !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      setTimeout(function(){searchFocus()},600);
    } else {
      $('#search-query, #search-query-mobile').blur();
    };

    e.preventDefault();
  });

  function searchFocus(){
    $('#search-query, #search-query-mobile').focus()
  }

  // search functionality
  $("#search-query").keypress(function(e){
    if(e.which == 13 && e.target.value != ""){
      window.location = '//www.miamidade.gov/search/home.asp#gsc.tab=0&gsc.q=' + escape(e.target.value);
    }
  });

  $("#search-button").on('click', function(e){
    var value = $("#search-query").val();
    if(value)
      window.location = '//www.miamidade.gov/search/home.asp#gsc.tab=0&gsc.q=' + escape(value);
  });


  //Had to set the action of the mobile search through here because the system was overriding the action inline on the form
  $("#cd-search > form, #cd-search-mobile > form").attr("action", "https://www.miamidade.gov/global/navigation/global-search.page");


  // Initialization of mobile menu
  $(".button-collapse").sideNav();
  //close mobile menu button

$('.close-mobile-menu').on('click', function(){
  $(".button-collapse").sideNav('hide');
});


  // mobile search
  $('input#search-query-mobile').focus(function() { $(this).parent().addClass('focused'); });
  $('input#search-query-mobile').blur(function() {
    if (!$(this).val()) {
      $(this).parent().removeClass('focused');
    }
  });




    //mobile jquery ------------

    var mobileMenu = $('#mobile-menu').unbind();

    mobileMenu.on('click', function(e) {
      e.preventDefault();

      $('.mobile-global-nav').addClass('active');

    });

    $('#mobile-global-close').on ('click', function(e){
      e.preventDefault();
      $('.mobile-global-nav').removeClass('active');
    });




  $('select').material_select();


if (window.innerWidth < '601'){

  //mobile targeting to close Service List Filters
  $('body').on('touchstart',function(event) {
    if (!$(event.target).closest('.search-filters').length && !$(event.target).closest('.toggle-filter').length) {
        $('body').removeClass('show-filters');
    };
  });

  //close Filters on mobile once a filter is selected
  $('.collapsible a').on('click', function(){
        $('body').removeClass('show-filters');
    });

}

  //toggles Service List Filters
  $('.toggle-filter').on('click',function(e){
    $('body').toggleClass('show-filters');
    e.preventDefault();
  });



  //fixing bug with active class for the label
  $('body').on('click',function(){

    if($('input.service-record__services-query__search-bar').val()){
      $('input.service-record__services-query__search-bar + label').addClass('active');
    }

  });

  $('.collapsible-header').removeClass('active');




  sticky_relocate();
  // check width and order global nav ------------
  doneResizing();
  // listen for resize event then fire doneResizing() ------------
  resizeId();
  // back to top button on every page
  backToTop();
  //initialization of modals
  //$('.modal-trigger').leanModal();



});